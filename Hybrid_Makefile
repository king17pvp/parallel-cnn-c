# Use NVCC for compiling everything (MPI-compatible)
NVCC = nvcc
CFLAGS = -Iinclude -O2
LDFLAGS = -lm

# Add support for MPI
MPIFLAGS = -Xcompiler "-fopenmp -fPIC" -lcudart -lmpi

# Source files for hybrid
SRC = src/run_hybrid.c src/cnn.c src/cnn_hybrid.c src/cnn_cuda.cu src/utils.c
TARGET = build/cnn_exec_hybrid

# Default build
all: $(TARGET)

# Link all sources into final executable
$(TARGET): $(SRC)
	$(NVCC) $(CFLAGS) -o $@ $^ $(LDFLAGS) $(MPIFLAGS)

# Run the hybrid executable (adjust -np as needed)
run: $(TARGET)
	mpirun -np 4 ./$(TARGET)

# Clean build artifacts
clean:
	rm -f $(TARGET)
